{% extends "base_auth.html" %}
{% set active_page = "docchat" %}
{% set page_title = "Document Intelligence" %}

{% block content %}

<style>
/* ===== Layout ===== */
.di-container { max-width: 1100px; }

.di-hero {
    background: #fff;
    border: 1px solid #E5E7EB;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 10px 24px rgba(0,0,0,.06);
}

.di-title { font-size: 22px; font-weight: 900; margin-bottom: 6px; }
.di-sub { color: #6B7280; margin-bottom: 18px; line-height: 1.6; max-width: 980px; }
.di-list { margin: 10px 0 0 0; padding-left: 18px; color: #374151; line-height: 1.7; }
.di-list li { margin: 8px 0; }

/* ===== Subtle tech badge ===== */
.di-badge {
    display: inline-block;
    font-size: 12px;
    font-weight: 800;
    padding: 6px 10px;
    border-radius: 999px;
    background: rgba(14,50,148,.08);
    border: 1px solid rgba(14,50,148,.20);
    color: #09102A;
    margin-bottom: 12px;
}

/* ===== Workflow diagram ===== */
.workflow-wrap{
    margin: 16px 0 18px;
    border: 1px solid #E5E7EB;
    border-radius: 14px;
    padding: 14px 14px 12px;
    background: linear-gradient(135deg, rgba(14,50,148,.04), rgba(235,118,1,.04));
}

.workflow-title{
    font-weight: 900;
    margin: 0 0 10px;
    font-size: 13px;
    letter-spacing: .4px;
    text-transform: uppercase;
    color: #111827;
}

.workflow{
    position: relative;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    align-items: start;
}

/* The connector line behind steps */
.workflow::before{
    content: "";
    position: absolute;
    left: 6%;
    right: 6%;
    top: 20px;
    height: 2px;
    border-radius: 999px;
    background: rgba(17,24,39,.10);
}

/* Animated highlight that sweeps across the connector */
.workflow::after{
    content: "";
    position: absolute;
    left: 6%;
    right: 6%;
    top: 20px;
    height: 2px;
    border-radius: 999px;
    background: linear-gradient(
      90deg,
      rgba(235,118,1,0) 0%,
      rgba(235,118,1,.55) 45%,
      rgba(14,50,148,.55) 55%,
      rgba(14,50,148,0) 100%
    );
    background-size: 220% 100%;
    animation: sweep 2.8s ease-in-out infinite;
    opacity: .65;
    mix-blend-mode: multiply;
}

@keyframes sweep{
    0%   { background-position: 0% 0%; opacity: .35; }
    40%  { opacity: .70; }
    100% { background-position: 100% 0%; opacity: .35; }
}

.step{
    position: relative;
    z-index: 1; /* above connector */
    text-align: center;
    padding: 2px 6px;
}

.step-dot{
    width: 14px;
    height: 14px;
    border-radius: 999px;
    margin: 0 auto 8px;
    background: rgba(235,118,1,.15);
    border: 1px solid rgba(235,118,1,.40);
    box-shadow: 0 0 0 rgba(235,118,1,0);
    animation: dotPulse 2.2s ease-in-out infinite;
}

@keyframes dotPulse{
    0%, 100% { box-shadow: 0 0 0 0 rgba(235,118,1,0); transform: scale(1); }
    50%      { box-shadow: 0 0 0 10px rgba(235,118,1,.10); transform: scale(1.03); }
}

/* Slightly different color for later stages to imply pipeline progression */
.step:nth-child(3) .step-dot{
    background: rgba(14,50,148,.10);
    border-color: rgba(14,50,148,.35);
    animation-delay: .15s;
}
.step:nth-child(4) .step-dot{
    background: rgba(235,118,1,.12);
    border-color: rgba(235,118,1,.32);
    animation-delay: .25s;
}
.step:nth-child(5) .step-dot{
    background: rgba(14,50,148,.10);
    border-color: rgba(14,50,148,.35);
    animation-delay: .35s;
}

.step-name{
    font-weight: 900;
    font-size: 12px;
    color: #111827;
    margin: 0 0 4px;
}

.step-desc{
    font-size: 12px;
    color: #6B7280;
    line-height: 1.4;
    margin: 0;
}

/* Mobile: stack steps nicely */
@media (max-width: 900px){
    .workflow{
        grid-template-columns: 1fr;
        gap: 14px;
    }
    .workflow::before, .workflow::after{
        left: 16px;
        right: auto;
        top: 10px;
        bottom: 10px;
        width: 2px;
        height: auto;
        background: rgba(17,24,39,.10);
    }
    .workflow::after{
        width: 2px;
        background: linear-gradient(
          180deg,
          rgba(235,118,1,0) 0%,
          rgba(235,118,1,.55) 45%,
          rgba(14,50,148,.55) 55%,
          rgba(14,50,148,0) 100%
        );
        background-size: 100% 220%;
        animation: sweepV 2.8s ease-in-out infinite;
        opacity: .65;
    }
    @keyframes sweepV{
        0%   { background-position: 0% 0%; opacity: .35; }
        40%  { opacity: .70; }
        100% { background-position: 0% 100%; opacity: .35; }
    }

    .step{
        text-align: left;
        padding-left: 34px;
    }
    .step-dot{
        position: absolute;
        left: 8px;
        top: 4px;
        margin: 0;
    }
}

/* Accessibility: respect reduced motion */
@media (prefers-reduced-motion: reduce){
    .workflow::after, .step-dot { animation: none !important; }
}

/* ===== Buttons ===== */
.btn-primary {
    background: #EB7601;
    color: #fff;
    border: none;
    padding: 10px 16px;
    border-radius: 12px;
    font-weight: 800;
    cursor: pointer;
}
.btn-primary:hover { filter: brightness(.95); }
.btn-primary:disabled { opacity: .65; cursor: not-allowed; }

.btn-secondary {
    background: #fff;
    border: 1px solid #E5E7EB;
    padding: 10px 16px;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
}
.btn-secondary:hover { border-color: #09102A; }
.btn-secondary:disabled { opacity: .65; cursor: not-allowed; }

/* ===== Modal ===== */
.modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal {
    background: #fff;
    width: min(950px, 95%);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 20px 45px rgba(0,0,0,.2);
    position: relative;
    transition: width .18s ease;
}

/* When chat is opened, modal expands */
.modal.chat-open {
    width: min(1280px, 96%);
}

.modal-header {
    padding: 14px 18px;
    border-bottom: 1px solid #E5E7EB;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #F9FAFB;
    font-weight: 900;
}

.modal-body {
    padding: 18px;
}

/* Two-column layout inside modal body when chat is open */
.modal-body-inner {
    display: block;
}
.modal.chat-open .modal-body-inner {
    display: flex;
    gap: 16px;
    align-items: flex-start;
}

/* Left panel always exists */
.left-panel {
    width: 100%;
}
.modal.chat-open .left-panel {
    width: 58%;
}

/* Right chat panel hidden by default */
.chat-panel {
    display: none;
    width: 42%;
    border: 1px solid #E5E7EB;
    border-radius: 14px;
    overflow: hidden;
    background: #fff;
}
.modal.chat-open .chat-panel {
    display: flex;
    flex-direction: column;
    height: 520px; /* adjust as needed */
}

/* ===== Footer ===== */
.modal-footer {
    padding: 14px 18px;
    border-top: 1px solid #E5E7EB;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* ===== Banner ===== */
.banner-success {
    display: none;
    padding: 10px 12px;
    border-radius: 12px;
    margin-bottom: 12px;
    background: rgba(16,185,129,.1);
    border: 1px solid rgba(16,185,129,.3);
    color: #065F46;
    font-weight: 800;
}

.banner-error {
    display: none;
    padding: 10px 12px;
    border-radius: 12px;
    margin-bottom: 12px;
    background: rgba(239,68,68,.1);
    border: 1px solid rgba(239,68,68,.3);
    color: #7F1D1D;
    font-weight: 800;
}

/* ===== Markdown Preview ===== */
.md-preview {
    border: 1px solid #E5E7EB;
    border-radius: 12px;
    padding: 12px;
    max-height: 420px;
    overflow: auto;
    background: #fff;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 12px;
    white-space: pre-wrap;
    opacity: 1;
    transition: opacity .18s ease;
}
.md-preview.faded { opacity: 0.35; }

.fade-in { animation: fadeIn .18s ease; }
@keyframes fadeIn { from { opacity: .2; } to { opacity: 1; } }

/* ===== Processing Overlay ===== */
.processing-overlay {
    display: none;
    position: absolute;
    inset: 0;
    background: rgba(255,255,255,.86);
    backdrop-filter: blur(2px);
    z-index: 5;
    align-items: center;
    justify-content: center;
    padding: 18px;
}

.processing-card {
    width: min(520px, 92%);
    background: #fff;
    border: 1px solid #E5E7EB;
    border-radius: 16px;
    box-shadow: 0 14px 30px rgba(0,0,0,.12);
    padding: 18px;
    text-align: center;
}

.spinner {
    border: 6px solid #f3f3f3;
    border-top: 6px solid #EB7601;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    animation: spin 1s linear infinite;
    margin: 6px auto 12px auto;
}
@keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

.processing-title { font-weight: 900; margin: 0 0 6px 0; }
.processing-status { color: #374151; margin: 0; font-weight: 600; }
.processing-sub { color: #6B7280; margin: 10px 0 0 0; font-size: 12px; }

.progress {
    height: 8px;
    border-radius: 999px;
    background: #F3F4F6;
    overflow: hidden;
    border: 1px solid #E5E7EB;
    margin-top: 14px;
}
.progress > div {
    height: 100%;
    width: 45%;
    border-radius: 999px;
    background: rgba(235,118,1,.85);
    animation: slide 1.2s ease-in-out infinite;
}
@keyframes slide { 0% { transform: translateX(-120%);} 100% { transform: translateX(260%);} }

/* ===== Chat UI ===== */
.chat-header {
    padding: 12px 12px;
    border-bottom: 1px solid #E5E7EB;
    background: #F9FAFB;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 900;
}

.chat-close {
    border: 1px solid #E5E7EB;
    background: #fff;
    border-radius: 10px;
    padding: 6px 10px;
    cursor: pointer;
    font-weight: 800;
}
.chat-close:hover { border-color: rgba(9,16,42,.25); }

.chat-messages {
    padding: 12px;
    overflow: auto;
    flex: 1;
    background: #fff;
}

.msg {
    display: flex;
    margin: 10px 0;
}
.msg.user { justify-content: flex-end; }
.msg.assistant { justify-content: flex-start; }

.bubble {
    max-width: 85%;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid #E5E7EB;
    white-space: pre-wrap;
    font-size: 13px;
    line-height: 1.35;
}
.msg.user .bubble {
    background: rgba(14,50,148,.08);
    border-color: rgba(14,50,148,.18);
}
.msg.assistant .bubble {
    background: rgba(17,24,39,.04);
}

.chat-input {
    border-top: 1px solid #E5E7EB;
    padding: 10px;
    background: #fff;
}
.chat-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
}
.chat-textarea {
    flex: 1;
    resize: none;
    border: 1px solid #E5E7EB;
    border-radius: 12px;
    padding: 10px 12px;
    font-size: 13px;
    min-height: 44px;
    max-height: 120px;
    outline: none;
}
.chat-textarea:focus { border-color: rgba(14,50,148,.35); }
.chat-send {
    min-width: 92px;
    height: 44px;
    border-radius: 12px;
    border: none;
    background: #0E3294;
    color: #fff;
    font-weight: 900;
    cursor: pointer;
}
.chat-send:hover { filter: brightness(.96); }
.chat-send:disabled { opacity: .65; cursor: not-allowed; }

.chat-hint {
    color: #6B7280;
    font-size: 12px;
    margin-top: 8px;
}
</style>

<div class="di-container">
    <div class="di-hero">

        <div class="di-title">Intelligent Document Platform</div>
        <div class="di-badge">Retrieval-Augmented Architecture • AI-Native Design</div>

        <div class="di-sub">
            Transform static PDFs and images into interactive, searchable knowledge assets.
            This module combines production-grade OCR, structured extraction, conversational AI,
            and session persistence into a unified document workspace.
        </div>

        <!-- Animated Workflow Diagram -->
        <div class="workflow-wrap">
            <div class="workflow-title">Workflow</div>
            <div class="workflow" aria-label="Upload to retrieval workflow diagram">
                <div class="step">
                    <div class="step-dot" aria-hidden="true"></div>
                    <div class="step-name">Upload</div>
                    <p class="step-desc">PDF or image</p>
                </div>
                <div class="step">
                    <div class="step-dot" aria-hidden="true"></div>
                    <div class="step-name">Extract</div>
                    <p class="step-desc">OCR + layout</p>
                </div>
                <div class="step">
                    <div class="step-dot" aria-hidden="true"></div>
                    <div class="step-name">Chat</div>
                    <p class="step-desc">Ask questions</p>
                </div>
                <div class="step">
                    <div class="step-dot" aria-hidden="true"></div>
                    <div class="step-name">Save</div>
                    <p class="step-desc">Session + output</p>
                </div>
                <div class="step">
                    <div class="step-dot" aria-hidden="true"></div>
                    <div class="step-name">Retrieve</div>
                    <p class="step-desc">Re-query later</p>
                </div>
            </div>
        </div>

        <h4>Platform Capabilities</h4>
        <ul class="di-list">
            <li><strong>Advanced AI OCR Engine</strong> – Extract high-fidelity text and layout from complex PDFs, scans, and multi-page documents.</li>
            <li><strong>Structured Transformation Layer</strong> – Convert unstructured content into clean Markdown and structured JSON for downstream automation.</li>
            <li><strong>Interactive Knowledge Chat</strong> – Ask contextual questions and receive grounded answers directly from the uploaded document.</li>
            <li><strong>Session-Aware Memory</strong> – Maintain conversation context throughout your session for iterative document analysis.</li>
            <li><strong>Persistent Document Workspace</strong> – Save documents and associated chat interactions for future retrieval and re-querying.</li>
            <li><strong>Enterprise Integration Ready</strong> – Built for API-based integration into operational systems and scalable document workflows.</li>
        </ul>

        <div style="
            margin-top:16px;
            padding:14px;
            border-radius:14px;
            background: linear-gradient(135deg, rgba(14,50,148,.05), rgba(235,118,1,.05));
            border: 1px solid rgba(14,50,148,.12);
        ">
            <div style="font-weight:800; margin-bottom:6px;">Vision</div>
            <div style="font-size:14px; color:#4B5563; line-height:1.6;">
                This platform is designed to evolve into a retrieval-enabled document intelligence layer capable of
                cross-document search, version tracking, audit history, and secure multi-user collaboration — forming the
                foundation for enterprise-grade document understanding systems.
            </div>
        </div>

        <div style="margin-top:18px;">
            <button class="btn-primary" onclick="openUploadModal()">Upload Document</button>
        </div>
    </div>
</div>

<!-- ================= MODAL ================= -->
<div class="modal-backdrop" id="uploadModal">
    <div class="modal" id="docModal">

        <!-- Processing Overlay -->
        <div class="processing-overlay" id="processingOverlay" aria-live="polite" aria-busy="true">
            <div class="processing-card">
                <div class="spinner"></div>
                <h4 class="processing-title">Processing document…</h4>
                <p class="processing-status" id="processingStatus">Uploading document</p>
                <div class="progress"><div></div></div>
                <p class="processing-sub" id="processingSub">This can take a few seconds for multi-page PDFs.</p>
            </div>
        </div>

        <div class="modal-header">
            Upload Document
            <button class="btn-secondary" id="btnCloseX" onclick="closeUploadModal()">✕</button>
        </div>

        <div class="modal-body">
            <div class="modal-body-inner">
                <!-- LEFT PANEL -->
                <div class="left-panel">
                    <div class="banner-success" id="successBanner">
                        Success • <span id="pageCount">0</span> page(s) read
                    </div>

                    <div class="banner-error" id="errorBanner">
                        Only PDF or image files are allowed.
                    </div>

                    <input type="file" id="fileInput" accept=".pdf,image/*" />

                    <div style="margin-top:14px;">
                        <h5>Markdown Preview</h5>
                        <div class="md-preview" id="markdownPreview">No document uploaded yet.</div>
                    </div>
                </div>

                <!-- RIGHT CHAT PANEL -->
                <div class="chat-panel" id="chatPanel">
                    <div class="chat-header">
                        Chat with Document
                        <button class="chat-close" type="button" onclick="closeChatPanel()">Close</button>
                    </div>

                    <div class="chat-messages" id="chatMessages"></div>

                    <div class="chat-input">
                        <div class="chat-row">
                            <textarea class="chat-textarea" id="chatInput" placeholder="Ask a question about this document…"></textarea>
                            <button class="chat-send" id="btnSend" type="button" onclick="sendQuestion()">Send</button>
                        </div>
                        <div class="chat-hint">Tip: Ask for totals, dates, parties, or “summarize key points”.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-secondary" id="btnClear" onclick="clearAndClose()">Close and clear document</button>
            <button class="btn-primary" id="chatButton" disabled onclick="openChatPanel()">
                Chat / Query with Document
            </button>
        </div>
    </div>
</div>

<script>
let currentDocId = null;
let currentMarkdown = "";
let isProcessing = false;

let statusTimer = null;
const statusSteps = [
    { text: "Uploading document", sub: "Securely transferring your file…" },
    { text: "Pre-processing image", sub: "Improving clarity for stronger OCR…" },
    { text: "Running AI OCR", sub: "Extracting text and layout…" },
    { text: "Building structured Markdown", sub: "Formatting output for preview…" }
];

function openUploadModal(){
    document.getElementById('uploadModal').style.display = 'flex';
}

function closeUploadModal(){
    if (isProcessing) return;
    closeChatPanel(true);
    document.getElementById('uploadModal').style.display = 'none';
}

function setProcessing(on){
    isProcessing = on;

    const overlay = document.getElementById('processingOverlay');
    const fileInput = document.getElementById('fileInput');
    const btnClear = document.getElementById('btnClear');
    const btnCloseX = document.getElementById('btnCloseX');

    overlay.style.display = on ? 'flex' : 'none';
    fileInput.disabled = on;
    btnClear.disabled = on;
    btnCloseX.disabled = on;

    const md = document.getElementById('markdownPreview');
    if (on) md.classList.add('faded');
    else md.classList.remove('faded');

    const btnSend = document.getElementById('btnSend');
    const chatInput = document.getElementById('chatInput');
    if (btnSend) btnSend.disabled = on;
    if (chatInput) chatInput.disabled = on;

    if (!on) stopStatusLoop();
}

function startStatusLoop(){
    stopStatusLoop();

    const statusEl = document.getElementById('processingStatus');
    const subEl = document.getElementById('processingSub');

    let i = 0;
    statusEl.textContent = statusSteps[i].text;
    subEl.textContent = statusSteps[i].sub;

    statusTimer = setInterval(() => {
        i = (i + 1) % statusSteps.length;
        statusEl.textContent = statusSteps[i].text;
        subEl.textContent = statusSteps[i].sub;
    }, 1400);
}

function stopStatusLoop(){
    if (statusTimer){
        clearInterval(statusTimer);
        statusTimer = null;
    }
}

async function clearAndClose(){
    if (isProcessing) return;

    if(currentDocId){
        try {
            await fetch(`/api/docchat/clear/${currentDocId}`, { method: "POST" });
        } catch(e){}
    }

    currentDocId = null;
    currentMarkdown = "";

    document.getElementById('markdownPreview').innerText = "No document uploaded yet.";
    document.getElementById('markdownPreview').classList.remove('fade-in');

    document.getElementById('successBanner').style.display = 'none';
    document.getElementById('errorBanner').style.display = 'none';

    document.getElementById('chatButton').disabled = true;

    document.getElementById('fileInput').value = "";

    // reset chat
    closeChatPanel(true);
    clearChatUI();

    closeUploadModal();
}

function showError(msg){
    const err = document.getElementById('errorBanner');
    err.innerText = msg || "Upload failed.";
    err.style.display = 'block';
    document.getElementById('successBanner').style.display = 'none';
    document.getElementById('chatButton').disabled = true;
}

function openChatPanel(){
    if (!currentDocId || !currentMarkdown) return;

    document.getElementById('docModal').classList.add('chat-open');
    document.getElementById('chatPanel').style.display = 'flex';

    // seed chat only once
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages.dataset.seeded){
        appendAssistant("Ask me anything about this document. Example: “What is the total allowed amount?”");
        chatMessages.dataset.seeded = "1";
    }

    setTimeout(() => {
        const input = document.getElementById('chatInput');
        if (input) input.focus();
    }, 50);
}

function closeChatPanel(force=false){
    if (!force && isProcessing) return;

    document.getElementById('docModal').classList.remove('chat-open');
    document.getElementById('chatPanel').style.display = 'none';
}

function clearChatUI(){
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = "";
    delete chatMessages.dataset.seeded;
    document.getElementById('chatInput').value = "";
}

function appendUser(text){
    const wrap = document.createElement("div");
    wrap.className = "msg user";
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;
    wrap.appendChild(bubble);
    document.getElementById("chatMessages").appendChild(wrap);
    scrollChatToBottom();
}

function appendAssistant(text){
    const wrap = document.createElement("div");
    wrap.className = "msg assistant";
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;
    wrap.appendChild(bubble);
    document.getElementById("chatMessages").appendChild(wrap);
    scrollChatToBottom();
}

function scrollChatToBottom(){
    const el = document.getElementById("chatMessages");
    el.scrollTop = el.scrollHeight;
}

async function sendQuestion(){
    if (isProcessing) return;

    const input = document.getElementById("chatInput");
    const btnSend = document.getElementById("btnSend");
    const question = (input.value || "").trim();

    if (!question) return;
    if (!currentDocId || !currentMarkdown) return;

    appendUser(question);
    input.value = "";
    btnSend.disabled = true;

    // lightweight typing indicator
    appendAssistant("…");
    const chatMessages = document.getElementById("chatMessages");
    const lastBubble = chatMessages.querySelector(".msg.assistant:last-child .bubble");

    try {
        const resp = await fetch("/api/docchat/query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                doc_id: currentDocId,
                question: question,
                markdown: currentMarkdown
            })
        });

        if (!resp.ok){
            let detail = "Query failed";
            try {
                const err = await resp.json();
                detail = err.detail || detail;
            } catch(e){}
            throw new Error(detail);
        }

        const data = await resp.json();
        if (lastBubble) lastBubble.textContent = data.answer || "(No answer returned)";
    } catch (e){
        if (lastBubble) lastBubble.textContent = "Error: " + (e.message || "Unable to answer");
    } finally {
        btnSend.disabled = false;
        scrollChatToBottom();
    }
}

document.getElementById('chatInput').addEventListener('keydown', function(e){
    // Enter = send, Shift+Enter = newline (ChatGPT-like)
    if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendQuestion();
    }
});

document.getElementById('fileInput').addEventListener('change', async function(){
    if (isProcessing) return;

    const file = this.files[0];
    if(!file) return;

    const allowed = file.type === "application/pdf" || file.type.startsWith("image/");
    if(!allowed){
        showError("Only PDF or image files are allowed.");
        return;
    }

    document.getElementById('errorBanner').style.display = 'none';

    const formData = new FormData();
    formData.append("file", file);

    try {
        setProcessing(true);
        startStatusLoop();

        const response = await fetch("/api/docchat/upload", {
            method: "POST",
            body: formData
        });

        if(!response.ok){
            let detail = "Upload failed";
            try {
                const err = await response.json();
                detail = err.detail || detail;
            } catch(e){}
            throw new Error(detail);
        }

        const data = await response.json();

        currentDocId = data.doc_id;
        currentMarkdown = data.markdown || "";

        document.getElementById('successBanner').style.display = 'block';
        document.getElementById('pageCount').innerText = data.pages;

        const md = document.getElementById('markdownPreview');
        md.classList.remove('fade-in');
        md.innerText = currentMarkdown || "(No text extracted.)";
        void md.offsetWidth;
        md.classList.add('fade-in');

        document.getElementById('chatButton').disabled = false;

        // Reset chat when a new doc is uploaded
        closeChatPanel(true);
        clearChatUI();

    } catch(error){
        showError(error.message);
    } finally {
        setProcessing(false);
    }
});
</script>

{% endblock %}
